name: Test1

on:
  schedule:
  - cron: "0 1 * * *"

jobs:
  dyff:
    name: yaml dyff
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Install tools
        run: |
          sudo snap install dyff
          dyff version
      - name: Download and diff yaml
        run: |
          PUBY="https://ica.illumina.com/ica/api/swagger/openapi_public.yaml"
          TMPY="openapi_tmp.yaml"
          CURY="openapi_current.yaml"

          curl -o ${TMPY} ${PUBY}
          if dyff between --omit-header --set-exit-code ${TMPY} ${CURY}; then 
              echo "diff=false" >> $GITHUB_ENV
          else
              echo "diff=true" >> $GITHUB_ENV
          fi

          echo "${{ env.diff }}"
          mv ${TMPY} ${CURY}
      - name: Commit if changes
        if: env.diff == 'true'
        run: |
          git status
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add .
          git commit -m "Update openapi yaml since dyffs detected"
          git push
